<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sell Phones Test Page</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .status { padding: 10px; margin: 10px 0; border-radius: 4px; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 4px; overflow-x: auto; }
        button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0056b3; }
        .phone-card { border: 1px solid #ddd; padding: 10px; margin: 10px 0; border-radius: 4px; }
    </style>
    <script src="admin.js?v=20260119" defer></script>
    <script src="quote.js?v=20260119" defer></script>
</head>
<body>
    <h1>üîß Sell Phones Backend Connection Test</h1>

    <div class="test-section">
        <h2>Test 1: localStorage Data</h2>
        <div id="test1-result"></div>
        <button onclick="test1()">Run Test 1</button>
    </div>

    <div class="test-section">
        <h2>Test 2: adminManager Availability</h2>
        <div id="test2-result"></div>
        <button onclick="test2()">Run Test 2</button>
    </div>

    <div class="test-section">
        <h2>Test 3: Backend Prices</h2>
        <div id="test3-result"></div>
        <button onclick="test3()">Run Test 3</button>
    </div>

    <div class="test-section">
        <h2>Test 4: Render Sample Models</h2>
        <div id="test4-result"></div>
        <button onclick="test4()">Run Test 4</button>
    </div>

    <div class="test-section">
        <h2>Test 5: Price Differences Check</h2>
        <div id="test5-result"></div>
        <button onclick="test5()">Run Test 5</button>
    </div>

    <div class="test-section">
        <h2>Quick Fix Tools</h2>
        <button onclick="fixDisplayIssues()">Fix Hidden Phones (display: false)</button>
        <button onclick="reimportData()">Instructions to Re-Import Data</button>
        <div id="fix-result"></div>
    </div>

    <script>
        function test1() {
            const result = document.getElementById('test1-result');
            const stored = localStorage.getItem('ktmobile_phones');

            if (!stored) {
                result.innerHTML = '<div class="error">‚ùå FAILED: No localStorage data found!<br>ACTION: Go to admin panel ‚Üí "Clear All & Fresh Import"</div>';
                return;
            }

            const phones = JSON.parse(stored);
            const applePhones = phones.filter(p => p.brand === 'Apple');
            const samsungPhones = phones.filter(p => p.brand === 'Samsung');
            const withUsed = phones.filter(p => p.storagePrices && Object.keys(p.storagePrices).length > 0);
            const withNew = phones.filter(p => p.newPhonePrices && Object.keys(p.newPhonePrices).length > 0);

            result.innerHTML = `
                <div class="success">‚úÖ PASSED: localStorage has phone data</div>
                <pre>
Total phones: ${phones.length}
Apple: ${applePhones.length}
Samsung: ${samsungPhones.length}
With USED prices: ${withUsed.length}
With NEW prices: ${withNew.length}
                </pre>
            `;
        }

        function test2() {
            const result = document.getElementById('test2-result');

            setTimeout(() => {
                if (typeof adminManager === 'undefined') {
                    result.innerHTML = '<div class="error">‚ùå FAILED: adminManager not defined<br>This means quote.js did not load properly</div>';
                    return;
                }

                if (!adminManager.phones || adminManager.phones.length === 0) {
                    result.innerHTML = '<div class="error">‚ùå FAILED: adminManager.phones is empty<br>ACTION: Run Test 1 to check localStorage</div>';
                    return;
                }

                result.innerHTML = `
                    <div class="success">‚úÖ PASSED: adminManager is available</div>
                    <pre>adminManager.phones: ${adminManager.phones.length} models loaded</pre>
                `;
            }, 500);
        }

        function test3() {
            const result = document.getElementById('test3-result');

            setTimeout(() => {
                if (typeof adminManager === 'undefined' || !adminManager.phones) {
                    result.innerHTML = '<div class="error">‚ùå FAILED: Run Test 2 first</div>';
                    return;
                }

                const iPhone15ProMax = adminManager.phones.find(p => p.model === 'iPhone 15 Pro Max');

                if (!iPhone15ProMax) {
                    result.innerHTML = '<div class="warning">‚ö†Ô∏è  iPhone 15 Pro Max not found in data</div>';
                    return;
                }

                const usedPrices = iPhone15ProMax.storagePrices || {};
                const newPrices = iPhone15ProMax.newPhonePrices || {};

                result.innerHTML = `
                    <div class="success">‚úÖ PASSED: Backend prices loaded</div>
                    <pre>
iPhone 15 Pro Max USED Prices:
${JSON.stringify(usedPrices, null, 2)}

iPhone 15 Pro Max NEW Prices:
${JSON.stringify(newPrices, null, 2)}
                    </pre>
                    ${usedPrices['256GB'] !== usedPrices['512GB']
                        ? '<div class="success">‚úÖ Prices are DIFFERENT (correct)</div>'
                        : '<div class="error">‚ùå All prices are SAME (incorrect!)</div>'}
                `;
            }, 500);
        }

        function test4() {
            const result = document.getElementById('test4-result');

            setTimeout(() => {
                if (typeof adminManager === 'undefined' || !adminManager.phones) {
                    result.innerHTML = '<div class="error">‚ùå FAILED: Run Test 2 first</div>';
                    return;
                }

                const usedPhones = adminManager.phones.filter(p =>
                    p.display !== false &&
                    p.available !== false &&
                    p.storagePrices &&
                    Object.keys(p.storagePrices).length > 0
                );

                let html = `<div class="success">‚úÖ PASSED: Can render ${usedPhones.length} USED phones</div>`;

                usedPhones.slice(0, 5).forEach(phone => {
                    const prices = Object.values(phone.storagePrices);
                    const maxPrice = Math.max(...prices);

                    html += `
                        <div class="phone-card">
                            <strong>${phone.brand} ${phone.model}</strong><br>
                            Max USED Price: $${maxPrice}<br>
                            Storages: ${phone.storages.join(', ')}<br>
                            Prices: ${JSON.stringify(phone.storagePrices)}
                        </div>
                    `;
                });

                result.innerHTML = html;
            }, 500);
        }

        function test5() {
            const result = document.getElementById('test5-result');

            setTimeout(() => {
                if (typeof adminManager === 'undefined' || !adminManager.phones) {
                    result.innerHTML = '<div class="error">‚ùå FAILED: Run Test 2 first</div>';
                    return;
                }

                let issues = [];

                adminManager.phones.forEach(phone => {
                    if (phone.storagePrices && Object.keys(phone.storagePrices).length > 1) {
                        const prices = Object.values(phone.storagePrices);
                        const allSame = prices.every(p => p === prices[0]);

                        if (allSame) {
                            issues.push(`${phone.brand} ${phone.model}: All USED prices are $${prices[0]}`);
                        }
                    }
                });

                if (issues.length === 0) {
                    result.innerHTML = '<div class="success">‚úÖ PASSED: All phones have different prices per storage</div>';
                } else {
                    result.innerHTML = `
                        <div class="error">‚ùå FOUND ${issues.length} phones with same prices:</div>
                        <pre>${issues.join('\n')}</pre>
                        <div class="warning">ACTION: Re-import data in admin panel</div>
                    `;
                }
            }, 500);
        }

        function fixDisplayIssues() {
            const stored = localStorage.getItem('ktmobile_phones');
            if (!stored) {
                document.getElementById('fix-result').innerHTML = '<div class="error">No data to fix</div>';
                return;
            }

            const phones = JSON.parse(stored);
            let fixed = 0;

            phones.forEach(phone => {
                if (phone.display === false) {
                    phone.display = true;
                    fixed++;
                }
                if (phone.available === false) {
                    phone.available = true;
                    fixed++;
                }
            });

            localStorage.setItem('ktmobile_phones', JSON.stringify(phones));

            document.getElementById('fix-result').innerHTML = `
                <div class="success">‚úÖ Fixed ${fixed} issues. Refresh sell-phones.html to see changes.</div>
            `;
        }

        function reimportData() {
            document.getElementById('fix-result').innerHTML = `
                <div class="info">
                    <h3>üìù How to Re-Import Backend Data:</h3>
                    <ol>
                        <li>Open: <a href="admin.html" target="_blank">admin.html</a></li>
                        <li>Go to: Buyback Management ‚Üí Import Prices</li>
                        <li>Click: "Clear All & Fresh Import"</li>
                        <li>Wait for alert: "Added: ~39 phones"</li>
                        <li>Return here and run all tests again</li>
                    </ol>
                </div>
            `;
        }

        // Auto-run all tests on load
        window.addEventListener('load', () => {
            setTimeout(() => {
                console.log('Auto-running all tests...');
                test1();
                setTimeout(() => test2(), 600);
                setTimeout(() => test3(), 1200);
                setTimeout(() => test4(), 1800);
                setTimeout(() => test5(), 2400);
            }, 1000);
        });
    </script>
</body>
</html>
